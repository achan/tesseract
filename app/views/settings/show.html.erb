<% content_for(:title, "Settings") %>

<h1 class="text-2xl font-bold mb-6">Settings</h1>

<div class="bg-card border border-border rounded-lg p-6 mb-6">
  <h2 class="text-lg font-semibold mb-4">System Health</h2>

  <div class="divide-y divide-border">
    <%# Deploy endpoint %>
    <div class="flex items-center justify-between py-2">
      <span class="text-sm">Deploy Endpoint</span>
      <span class="text-sm text-muted flex items-center gap-2">
        <% if @health[:deploy][:configured] %>
          Configured<%= @health[:deploy][:last_deploy] ? " · last deploy #{time_ago_label(@health[:deploy][:last_deploy])}" : "" %>
        <% else %>
          Not configured
        <% end %>
        <%= health_dot(@health[:deploy][:configured] ? :green : :red) %>
      </span>
    </div>

    <%# Slack events %>
    <% event_status, event_text = health_time_status(@health[:slack_events][:last_received]) %>
    <div class="flex items-center justify-between py-2">
      <span class="text-sm">Slack Events</span>
      <span class="text-sm text-muted flex items-center gap-2">
        Last received <%= event_text %>
        <%= health_dot(event_status) %>
      </span>
    </div>

    <%# Summarization %>
    <% sum_status, sum_text = health_time_status(@health[:summarization][:last_run], green_threshold: 24.hours, yellow_threshold: 72.hours) %>
    <div class="flex items-center justify-between py-2">
      <span class="text-sm">Summarization</span>
      <span class="text-sm text-muted flex items-center gap-2">
        Last run <%= sum_text %><%= @health[:summarization][:failed] > 0 ? " · #{@health[:summarization][:failed]} failed" : "" %>
        <%= health_dot(sum_status) %>
      </span>
    </div>

    <%# Action items %>
    <% ai_status, ai_text = health_time_status(@health[:action_items][:last_run], green_threshold: 24.hours, yellow_threshold: 72.hours) %>
    <div class="flex items-center justify-between py-2">
      <span class="text-sm">Action Items</span>
      <span class="text-sm text-muted flex items-center gap-2">
        Last run <%= ai_text %><%= @health[:action_items][:failed] > 0 ? " · #{@health[:action_items][:failed]} failed" : "" %>
        <%= health_dot(ai_status) %>
      </span>
    </div>

    <%# Cleanup %>
    <% cleanup_status, cleanup_text = health_time_status(@health[:cleanup][:last_run], green_threshold: 25.hours, yellow_threshold: 48.hours) %>
    <div class="flex items-center justify-between py-2">
      <span class="text-sm">Cleanup Job</span>
      <span class="text-sm text-muted flex items-center gap-2">
        Last run <%= cleanup_text %>
        <%= health_dot(cleanup_status) %>
      </span>
    </div>

    <%# Queue health %>
    <div class="flex items-center justify-between py-2">
      <span class="text-sm flex items-center gap-1">
        Queue Health
        <%= link_to mission_control_jobs_path, class: "text-muted hover:text-foreground" do %>
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        <% end %>
      </span>
      <span class="text-sm text-muted flex items-center gap-2">
        <%= @health[:queue][:in_progress] %> in progress · <%= @health[:queue][:queued] %> queued<%= @health[:queue][:failed_jobs] > 0 ? " · #{@health[:queue][:failed_jobs]} failed" : "" %>
        <%= health_dot(@health[:queue][:workers_alive] > 0 ? :green : :red) %>
      </span>
    </div>

    <%# Database size %>
    <div class="flex items-center justify-between py-2">
      <span class="text-sm">Database Size</span>
      <span class="text-sm text-muted flex items-center gap-2">
        <%= @health[:database][:size] ? number_to_human_size(@health[:database][:size]) : "Unknown" %>
        <%= health_dot(:gray) %>
      </span>
    </div>
  </div>
</div>

<div class="bg-card border border-border rounded-lg p-6 mb-6">
  <h2 class="text-lg font-semibold mb-4">Actions</h2>
  <div class="flex items-center justify-between py-2">
    <div>
      <span class="text-sm">Regenerate Overview</span>
      <p class="text-xs text-muted">Generate a new cross-channel overview from the last hour of activity.</p>
    </div>
    <%= button_to "Generate", overviews_path, method: :post,
          class: "inline-flex items-center px-3 py-1.5 text-sm font-medium bg-secondary text-secondary-foreground rounded-md hover:bg-accent cursor-pointer",
          data: { turbo: true } %>
  </div>
</div>

<div class="bg-card border border-border rounded-lg p-6">
  <h2 class="text-lg font-semibold mb-4">Channels</h2>
  <p class="text-sm text-muted mb-6">
    Click the star to show or hide a channel from the dashboard feed.
    Click the bolt to enable or disable auto-summaries.
  </p>

  <% Workspace.includes(:slack_channels).find_each do |workspace| %>
    <% channels = workspace.slack_channels.current.order(:channel_name) %>
    <% next if channels.empty? %>

    <div class="mb-6">
      <h3 class="text-sm font-semibold text-muted uppercase tracking-wide mb-2"><%= workspace.team_name %></h3>
      <ul class="divide-y divide-border">
        <% channels.each do |channel| %>
          <li class="flex items-center justify-between py-2">
            <%= link_to channel.display_name, workspace_slack_channel_path(workspace, channel),
                  class: "text-sm hover:underline" %>
            <div class="flex items-center gap-2">
              <%= render "slack_channels/star", workspace: workspace, channel: channel %>
              <%= render "slack_channels/actionable", workspace: workspace, channel: channel %>
            </div>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>
</div>

<% if http_basic_auth_configured? %>
  <div class="bg-card border border-border rounded-lg p-6 mt-6">
    <h2 class="text-lg font-semibold mb-4">Session</h2>
    <%= button_to "Log out", logout_path,
          method: :post,
          class: "text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 cursor-pointer bg-transparent border-0 p-0 underline" %>
  </div>
<% end %>

<p class="text-xs text-muted mt-6 text-center"><%= Rails.application.config.version %></p>
