<% if event.event_type == "message" %>
  <% workspace = event.slack_channel.workspace %>
  <% if event.user_id.present? %>
    <% sender_profile = workspace.resolve_user_profile(event.user_id) %>
  <% else %>
    <% sender_profile = workspace.resolve_bot_profile(event.payload&.dig("bot_id")) %>
  <% end %>
  <% avatar_url = sender_profile[:avatar] %>

  <div id="<%= dom_id(event) %>" class="bg-card border border-border rounded-md px-4 py-3 mb-2"
       data-controller="lightbox" data-action="keydown@window->lightbox#closeOnKey">
    <div class="flex gap-3">
      <div class="flex-shrink-0 pt-0.5">
        <% if avatar_url %>
          <img src="<%= avatar_url %>" alt="" class="w-10 h-10 rounded-full">
        <% else %>
          <div class="w-10 h-10 rounded-full bg-secondary"></div>
        <% end %>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 text-sm">
          <span class="font-semibold text-foreground truncate"><%= sender_profile[:name] %></span>
          <div class="ml-auto flex-shrink-0 flex items-center gap-2">
            <button type="button" title="Reply"
                    data-action="reply-modal#open"
                    data-event-id="<%= event.id %>"
                    data-author-name="<%= sender_profile[:name] %>"
                    data-message-preview="<%= truncate(event.payload&.dig("text") || "", length: 120) %>"
                    class="text-muted hover:text-foreground">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
              </svg>
            </button>
            <% if workspace.team_id.present? && event.ts.present? %>
              <a href="slack://channel?team=<%= workspace.team_id %>&id=<%= event.slack_channel.channel_id %>&message=<%= event.ts.delete(".") %>"
                 class="text-xs text-muted hover:text-foreground" title="Open in Slack">
                <time datetime="<%= event.created_at.iso8601 %>" data-controller="local-time"></time>
              </a>
            <% else %>
              <time datetime="<%= event.created_at.iso8601 %>" class="text-xs text-muted" data-controller="local-time"></time>
            <% end %>
          </div>
        </div>
        <% body = render_event_body(event) %>
        <% if body.present? %>
          <div data-controller="expandable">
            <div class="text-sm prose prose-sm max-w-none mt-1 max-h-24 overflow-hidden"
                 data-expandable-target="content">
              <%= body %>
            </div>
            <button class="text-xs text-primary hover:underline mt-1"
                    data-expandable-target="toggle"
                    data-action="expandable#toggle">
              Show more
            </button>
          </div>
        <% end %>
      </div>
    </div>
    <%= render "shared/lightbox_overlay" %>
  </div>
<% else %>
  <div id="<%= dom_id(event) %>" class="bg-card border border-border rounded-md px-4 py-3 mb-2"
       data-controller="lightbox" data-action="keydown@window->lightbox#closeOnKey">
    <div class="flex gap-3 text-xs text-muted mb-1">
      <span class="bg-secondary px-1.5 py-0.5 rounded text-[0.7rem]"><%= event.event_type %></span>
      <span><%= event.user_id %></span>
      <time datetime="<%= event.created_at.iso8601 %>" data-controller="local-time-display"><%= event.created_at.strftime("%b %d, %H:%M") %></time>
      <% workspace = event.slack_channel.workspace %>
      <% if workspace.team_id.present? && event.ts.present? %>
        <a href="slack://channel?team=<%= workspace.team_id %>&id=<%= event.slack_channel.channel_id %>&message=<%= event.ts.delete(".") %>"
           class="text-primary hover:underline ml-auto" title="Open in Slack">
          Slack &#x2197;
        </a>
      <% end %>
    </div>
    <% body = render_event_body(event) %>
    <% if body.present? %>
      <div class="text-sm prose prose-sm max-w-none"><%= body %></div>
    <% end %>
    <% if event.thread_ts.present? %>
      <span class="inline-block text-xs text-primary mt-1">Thread</span>
    <% end %>
    <%= render "shared/lightbox_overlay" %>
  </div>
<% end %>
