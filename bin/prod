#!/usr/bin/env bash

set -e

export RAILS_ENV=production
export SOLID_QUEUE_IN_PUMA=1
export PORT="${PORT:-6001}"

# Read tunnel ID from .worktreerc
CLOUDFLARE_TUNNEL_ID=$(grep "^CLOUDFLARE_TUNNEL_ID=" .worktreerc | cut -d'=' -f2)

bin/rails assets:precompile
bin/rails db:prepare

# Start cloudflared tunnel in the background
if [ -n "$CLOUDFLARE_TUNNEL_ID" ]; then
  CLOUDFLARE_TOKEN=$(cloudflared tunnel token "$CLOUDFLARE_TUNNEL_ID")
  cloudflared tunnel --loglevel debug --logfile cloudflared.log run --token "$CLOUDFLARE_TOKEN" &
  TUNNEL_PID=$!
  echo "Started cloudflared tunnel (PID: $TUNNEL_PID)"

  # Ensure tunnel is stopped when the script exits
  trap "kill $TUNNEL_PID 2>/dev/null" EXIT
else
  echo "Warning: No CLOUDFLARE_TUNNEL_ID found in .worktreerc, skipping tunnel"
fi

exec bin/rails server
