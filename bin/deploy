#!/usr/bin/env bash
set -e

cd "$(dirname "$0")/.."

LOCK_DIR="tmp/deploy.lock"
if ! mkdir "$LOCK_DIR" 2>/dev/null; then
  echo "$(date '+%Y-%m-%d %H:%M:%S') Deploy already in progress, skipping"
  exit 0
fi
trap 'rmdir "$LOCK_DIR"' EXIT

echo "$(date '+%Y-%m-%d %H:%M:%S') Starting deploy..."

echo "$(date '+%Y-%m-%d %H:%M:%S') Pulling latest code..."
git pull origin main

echo "$(date '+%Y-%m-%d %H:%M:%S') Installing dependencies..."
bundle install --jobs 4

echo "$(date '+%Y-%m-%d %H:%M:%S') Precompiling assets..."
RAILS_ENV=production bin/rails assets:precompile

echo "$(date '+%Y-%m-%d %H:%M:%S') Running migrations..."
RAILS_ENV=production bin/rails db:migrate

echo "$(date '+%Y-%m-%d %H:%M:%S') Restarting puma..."
touch tmp/restart.txt

echo "$(date '+%Y-%m-%d %H:%M:%S') Deploy complete."
